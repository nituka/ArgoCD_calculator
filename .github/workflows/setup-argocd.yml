# ArgoCD Infrastructure Setup
name: Setup ArgoCD Infrastructure

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'install'
        type: choice
        options:
        - install
        - destroy
  push:
    branches: [ main ]
    paths:
      - 'manifests/**'
      - 'applications/**'

env:
  CLUSTER_NAME: calculator-argocd

jobs:
  setup-argocd:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout ArgoCD Config
      uses: actions/checkout@v4
    
    - name: Setup Kind Cluster
      uses: helm/kind-action@v1.8.0
      with:
        cluster_name: ${{ env.CLUSTER_NAME }}
        wait: 300s
    
    - name: Install ArgoCD
      run: |
        echo "ğŸ¯ Installing ArgoCD..."
        kubectl create namespace argocd
        kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
        
        echo "â³ Waiting for ArgoCD deployments to be created..."
        sleep 30
        
        echo "ğŸ“‹ ArgoCD deployments found:"
        kubectl get deployments -n argocd
        
        echo "â³ Waiting for all ArgoCD deployments to be ready..."
        
        # Wait for all deployments in argocd namespace to be available
        for deployment in $(kubectl get deployments -n argocd -o name); do
          echo "â³ Waiting for $deployment..."
          kubectl wait --for=condition=available --timeout=300s $deployment -n argocd
        done
        
        echo "âœ… All ArgoCD deployments are ready!"
        
        # Verify ArgoCD is working
        echo "ğŸ” Final status check:"
        kubectl get pods -n argocd
    
    - name: Create Calculator Namespace
      run: |
        echo "ğŸ“ Creating calculator-app namespace..."
        kubectl apply -f manifests/namespace.yaml
    
    - name: Setup ArgoCD Application
      run: |
        echo "ğŸ¯ Creating ArgoCD application..."
        kubectl apply -f applications/python-calculator-app.yaml
        echo "âœ… ArgoCD application created!"
    
    - name: Get ArgoCD Access Details
      run: |
        echo "ğŸ”‘ Getting ArgoCD access details..."
        
        # Get admin password
        ARGOCD_PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
        
        echo ""
        echo "ğŸ‰ ARGOCD INFRASTRUCTURE READY!"
        echo "==============================="
        echo "ğŸŒ ArgoCD UI: https://localhost:8080"
        echo "ğŸ‘¤ Username: admin"
        echo "ğŸ”‘ Password: $ARGOCD_PASSWORD"
        echo ""
        echo "ğŸš€ To access ArgoCD:"
        echo "   kubectl port-forward svc/argocd-server -n argocd 8080:443"
        echo ""
        echo "ğŸ“± Your Calculator App will appear when image is pushed from githubActions repo"
    
    - name: Simple ArgoCD Verification
      run: |
        echo "ğŸ” Infrastructure Check"
        echo "======================"
        
        echo "âœ… All ArgoCD Pods:"
        kubectl get pods -n argocd
        
        echo ""
        echo "âœ… ArgoCD Applications:"
        kubectl get applications -n argocd || echo "No applications yet (this is normal)"
        
        echo ""
        echo "âœ… Calculator Namespace:"
        kubectl get namespace calculator-app
        
        echo ""
        echo "ğŸ¯ ArgoCD Infrastructure is ready!"
        echo "ğŸ“ Next: Push code to githubActions repo to trigger deployment"